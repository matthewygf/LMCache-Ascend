name: 'CI: Lint & Ascend 910B Test'

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main', '*-dev']

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint & Style Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install pre-commit
      - run: pre-commit run --all-files

  # ==========================================
  # JOB 2: TEST (Container Mode)
  # ==========================================
  test-native:
    name: Test on 910B (vLLM Image)
    needs: lint
    runs-on: [self-hosted, Linux, ARM64, 910b4]
    timeout-minutes: 30

    container:
      image: quay.io/ascend/vllm-ascend:v0.10.2rc1-openeuler
      
      options: >-
        --device /dev/davinci0
        --device /dev/davinci_manager
        --device /dev/devmm_svm
        --device /dev/hisi_hdc
        -v /usr/local/Ascend/driver:/usr/local/Ascend/driver
        -v /usr/local/dcmi:/usr/local/dcmi
        -v /etc/pki/ca-trust:/etc/pki/ca-trust
        --user root

    env:
      SOC_VERSION: Ascend910B4
      PIP_INDEX_URL: https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple
      LMCACHE_TRACK_USAGE: false
      NO_CUDA_EXT: 1

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: ðŸ“¦ Install LMCache & Build Project
        run: |
          echo ">>> Setting up Pip..."
          pip config set global.index-url ${{ env.PIP_INDEX_URL }}
          
          echo ">>> Installing LMCache Core..."
          # From your Dockerfile: NO_CUDA_EXT=1 is set in 'env' above
          pip install lmcache==0.3.7

          echo ">>> Building LMCache-Ascend..."
          # We need to export these variables just like your Dockerfile does
          export CPLUS_INCLUDE_PATH=/usr/include/c++/12:/usr/include/c++/12/backward:/usr/include/c++/12/aarch64-openEuler-linux/:$CPLUS_INCLUDE_PATH
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/Ascend/ascend-toolkit/latest/$(uname -i)-linux/devlib
          
          # Install in editable mode (-e) for testing
          python3 -m pip install -v --no-build-isolation -e . 
          
      - name: ðŸ§ª Run Unit Tests
        run: |
          # Ensure env vars persist for the test run
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/Ascend/ascend-toolkit/latest/$(uname -i)-linux/devlib
          
          echo ">>> Install pytest dependencies"
          pip install pytest pytest-benchmark

          echo ">>> Starting Pytest..."
          # Since we are using 'container:' mode, logging is reliable.
          python3 -m pytest -v -s tests/v1