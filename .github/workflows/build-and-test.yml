name: 'CI: Lint & Ascend 910B Test'

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main', '*-dev']

permissions:
  contents: read
  checks: write
  actions: read
  statuses: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint & Style Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install pre-commit
      - run: pre-commit run --all-files

  # ==========================================
  # JOB 2: TEST (Container Mode)
  # ==========================================
  test-native:
    name: Test on 910B (vLLM Image)
    needs: lint
    runs-on: [self-hosted, Linux, ARM64, 910b4]
    timeout-minutes: 30

    container:
      image: quay.io/ascend/vllm-ascend:v0.10.2rc1-openeuler
      
      options: >-
        --network host
        --device /dev/davinci0
        --device /dev/davinci_manager
        --device /dev/devmm_svm
        --device /dev/hisi_hdc
        -v /usr/local/Ascend/driver:/usr/local/Ascend/driver
        -v /usr/local/dcmi:/usr/local/dcmi
        -v /etc/pki/ca-trust:/etc/pki/ca-trust
        --user root

    env:
      SOC_VERSION: Ascend910B4
      PIP_INDEX_URL: https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple
      LMCACHE_TRACK_USAGE: false
      NO_CUDA_EXT: 1
      NODE_EXTRA_CA_CERTS: /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem
      LMCACHE_LOG_LEVEL: WARNING # otherwise the logs get too noisy

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true
      
      - name: üîß Fix Git Safe Directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: üì¶ Install LMCache & Build Project
        run: |
          echo ">>> Setting up Pip..."
          pip config set global.index-url ${{ env.PIP_INDEX_URL }}
          
          echo ">>> Installing LMCache Core..."
          # From your Dockerfile: NO_CUDA_EXT=1 is set in 'env' above
          pip install lmcache==0.3.7

          echo ">>> Building LMCache-Ascend..."
          # We need to export these variables just like your Dockerfile does
          export CPLUS_INCLUDE_PATH=/usr/include/c++/12:/usr/include/c++/12/backward:/usr/include/c++/12/aarch64-openEuler-linux/:$CPLUS_INCLUDE_PATH
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/Ascend/ascend-toolkit/latest/$(uname -i)-linux/devlib
          
          # Install in editable mode (-e) for testing
          python3 -m pip install -v --no-build-isolation -e . 
      
      - name: Install Pytest Dependencies
        run: |
          pip install pytest pytest-benchmark pytest-cov
          
      - name: üß™ Run Unit Tests
        id: test-step
        shell: bash
        run: |
          # 1. Setup Env
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/Ascend/ascend-toolkit/latest/$(uname -i)-linux/devlib
          
          # 2. Disable "Exit on Error" so we can run the summary script even if tests fail
          set +e 
          
          echo ">>> Starting Pytest..."
          
          # 3. Run Test (Pipe to tee for visibility + file)
          #    We rely on ${PIPESTATUS[0]} to capture the python exit code, not tee's.
          python3 -u -m pytest -v -s tests/v1 \
            -W "ignore:coroutine 'AsyncPQThreadPoolExecutor._worker' was never awaited" \
            -W "ignore:coroutine 'AsyncPQExecutor._worker' was never awaited" \
            -W "ignore:Task was destroyed but it is pending!" \
            -W "ignore:Exception ignored in" \
            --tb=short \
            --junit-xml=test-results.xml \
            --color=yes 2>&1 | tee full_logs.txt
          
          # Capture the exit code of the FIRST command in the pipe (pytest)
          EXIT_CODE=${PIPESTATUS[0]}
          
          # 4. Re-enable "Exit on Error" (good practice)
          set -e
          
          echo ""
          echo "============= TEST SUMMARY ============="
          echo "Final Exit Code: $EXIT_CODE"
          
          # Grep the summary line (Passed/Failed count)
          if [ -f full_logs.txt ]; then
             grep -E "passed|failed|error|skipped" full_logs.txt | tail -1 || echo "Summary not found in logs."
          fi
          
          # 5. Fail the job manually if needed
          if [ $EXIT_CODE -ne 0 ]; then
             echo "‚ùå Tests Failed."
             exit $EXIT_CODE
          else
             echo "‚úÖ Tests Passed."
             exit 0
          fi

      - name: üì§ Upload Full Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-910b
          path: full_logs.txt
      
      - name: üìä Publish Test Report
        if: always()  # Run even if tests fail
        uses: dorny/test-reporter@v1
        with:
          name: NPU Test Results            # Name of the Check Run
          path: test-results.xml            # Path to the XML file we generated
          reporter: java-junit              # Format (Pytest produces JUnit-style XML)
          fail-on-error: false              # Don't fail the step itself if tests failed